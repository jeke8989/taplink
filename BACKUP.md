# Инструкция по резервному копированию базы данных BioHub

Эта документация описывает систему автоматического резервного копирования базы данных PostgreSQL для проекта BioHub.

## Обзор

Система бэкапов включает:
- Автоматические ежедневные бэкапы базы данных
- Сжатие бэкапов для экономии места
- Проверку целостности бэкапов
- Автоматическое удаление старых бэкапов (старше 7 дней)
- Скрипты для восстановления и проверки бэкапов
- Генерацию сложных паролей для базы данных

## Структура файлов

```
/root/biohub/
├── scripts/
│   ├── backup-db.sh          # Скрипт автоматического бэкапа
│   ├── restore-db.sh          # Скрипт восстановления из бэкапа
│   ├── generate-db-password.sh # Скрипт генерации пароля
│   └── check-backups.sh       # Скрипт проверки бэкапов
├── backups/                   # Директория для бэкапов (монтируется в контейнер)
└── .env                       # Файл с настройками (включая пароль БД)
```

## Настройка автоматических бэкапов

### 1. Установка прав доступа

Убедитесь, что все скрипты имеют права на выполнение:

```bash
chmod +x scripts/*.sh
```

### 2. Создание директории для бэкапов

Директория будет создана автоматически при первом запуске скрипта, но вы можете создать её вручную:

```bash
mkdir -p /root/biohub-backups
chmod 700 /root/biohub-backups
```

### 3. Настройка cron для автоматических бэкапов

Добавьте задачу в crontab для ежедневных бэкапов в 3:00 ночи:

```bash
crontab -e
```

Добавьте следующую строку:

```
0 3 * * * /root/biohub/scripts/backup-db.sh >> /var/log/biohub-backup.log 2>&1
```

Для проверки cron задач:

```bash
crontab -l
```

### 4. Проверка логов

Логи бэкапов сохраняются в `/var/log/biohub-backup.log`. Для просмотра:

```bash
tail -f /var/log/biohub-backup.log
```

## Использование скриптов

### Создание бэкапа вручную

```bash
cd /root/biohub
./scripts/backup-db.sh
```

Скрипт:
- Создаст бэкап базы данных
- Сожмет его с помощью gzip
- Проверит целостность
- Удалит бэкапы старше 7 дней
- Выведет статистику

### Восстановление из бэкапа

**ВНИМАНИЕ:** Восстановление из бэкапа полностью заменит все данные в базе данных!

```bash
cd /root/biohub
./scripts/restore-db.sh /root/biohub-backups/biohub_backup_20241120_030000.sql.gz
```

Или для несжатого файла:

```bash
./scripts/restore-db.sh /root/biohub-backups/biohub_backup_20241120_030000.sql
```

Скрипт:
- Попросит подтверждение перед восстановлением
- Распакует файл если нужно
- Восстановит базу данных
- Покажет результат операции

### Проверка бэкапов

Для проверки наличия и целостности бэкапов:

```bash
cd /root/biohub
./scripts/check-backups.sh
```

Скрипт покажет:
- Количество бэкапов за последние 7 дней
- Информацию о последнем бэкапе
- Результат проверки целостности
- Список всех бэкапов
- Общую статистику

### Генерация нового пароля для базы данных

Для генерации сложного пароля (32 символа):

```bash
cd /root/biohub
./scripts/generate-db-password.sh
```

Скрипт:
- Сгенерирует случайный пароль
- Покажет пароль для сохранения
- Предложит обновить `.env` файл
- Даст инструкции по обновлению пароля в PostgreSQL

**После генерации нового пароля необходимо:**

1. Обновить пароль в PostgreSQL:
```bash
docker exec -it biohub-postgres psql -U postgres -c "ALTER USER postgres WITH PASSWORD 'новый_пароль';"
```

2. Перезапустить backend контейнер:
```bash
docker-compose restart backend
```

## Формат файлов бэкапов

Бэкапы сохраняются в формате:
```
biohub_backup_YYYYMMDD_HHMMSS.sql.gz
```

Где:
- `YYYYMMDD` - дата создания (год, месяц, день)
- `HHMMSS` - время создания (час, минута, секунда)

Пример: `biohub_backup_20241120_030000.sql.gz`

## Хранение бэкапов

- **Локальное хранение:** `/root/biohub-backups/`
- **Срок хранения:** 7 дней (автоматическое удаление старых)
- **Сжатие:** Все бэкапы сжимаются с помощью gzip
- **Права доступа:** 700 (только root может читать/писать)

## Мониторинг и уведомления

### Проверка статуса бэкапов

Для регулярной проверки статуса бэкапов можно добавить в cron:

```bash
# Проверка бэкапов каждый день в 4:00 утра
0 4 * * * /root/biohub/scripts/check-backups.sh >> /var/log/biohub-backup-check.log 2>&1
```

### Настройка уведомлений (опционально)

Вы можете настроить отправку email при ошибках бэкапа, добавив в скрипт `backup-db.sh`:

```bash
# В конце скрипта, если exit code != 0
if [ $? -ne 0 ]; then
    echo "Backup failed!" | mail -s "BioHub Backup Error" admin@example.com
fi
```

## Восстановление после сбоя

### Сценарий 1: Восстановление базы данных

1. Остановите приложение:
```bash
cd /root/biohub
docker-compose stop backend
```

2. Восстановите из бэкапа:
```bash
./scripts/restore-db.sh /root/biohub-backups/biohub_backup_YYYYMMDD_HHMMSS.sql.gz
```

3. Запустите приложение:
```bash
docker-compose start backend
```

### Сценарий 2: Восстановление на новом сервере

1. Установите Docker и Docker Compose
2. Скопируйте проект и бэкап на новый сервер
3. Настройте `.env` файл
4. Запустите контейнеры:
```bash
docker-compose up -d postgres
```

5. Дождитесь готовности PostgreSQL:
```bash
docker-compose ps
```

6. Восстановите базу данных:
```bash
./scripts/restore-db.sh /path/to/backup.sql.gz
```

7. Запустите остальные сервисы:
```bash
docker-compose up -d
```

## Безопасность

### Рекомендации

1. **Храните пароли в безопасности:** Не коммитьте `.env` файл в git
2. **Ограничьте доступ:** Директория бэкапов должна быть доступна только root
3. **Регулярно проверяйте бэкапы:** Запускайте `check-backups.sh` регулярно
4. **Тестируйте восстановление:** Периодически тестируйте восстановление на тестовой базе
5. **Храните бэкапы вне сервера:** Рассмотрите возможность синхронизации бэкапов на внешний сервер или облачное хранилище

### Синхронизация на внешний сервер (опционально)

Для дополнительной защиты можно настроить синхронизацию бэкапов на внешний сервер:

```bash
# Добавить в cron после создания бэкапа
rsync -avz --delete /root/biohub-backups/ user@backup-server.com:/backups/biohub/
```

## Устранение неполадок

### Проблема: Скрипт не может найти .env файл

**Решение:** Убедитесь, что вы запускаете скрипт из директории проекта или укажите правильный путь к `.env`

### Проблема: Контейнер PostgreSQL не запущен

**Решение:** 
```bash
docker-compose ps
docker-compose up -d postgres
```

### Проблема: Недостаточно места на диске

**Решение:** 
- Проверьте свободное место: `df -h`
- Удалите старые бэкапы вручную: `find /root/biohub-backups -name "*.sql.gz" -mtime +7 -delete`
- Рассмотрите возможность увеличения диска

### Проблема: Бэкап не создается

**Решение:**
1. Проверьте логи: `tail -f /var/log/biohub-backup.log`
2. Проверьте права доступа: `ls -la scripts/backup-db.sh`
3. Проверьте подключение к БД: `docker exec biohub-postgres pg_isready -U postgres`

## Дополнительные ресурсы

- [Документация PostgreSQL pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)
- [Документация Docker Compose](https://docs.docker.com/compose/)
- [Документация cron](https://man7.org/linux/man-pages/man5/crontab.5.html)

## Поддержка

При возникновении проблем проверьте:
1. Логи бэкапов: `/var/log/biohub-backup.log`
2. Логи Docker: `docker-compose logs postgres`
3. Статус контейнеров: `docker-compose ps`

